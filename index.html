<!DOCTYPE html>
<html lang="it" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
  
  <title>LibrAI ‚Ä¢ Il tuo assistente di lettura intelligente</title>
  <meta name="description" content="Trova il tuo prossimo libro preferito con l'AI. Analisi, riassunti, piani di lettura e comparazione prezzi in un click.">
  <meta name="keywords" content="libri, AI, recensioni libri, consigli lettura, sconti libri">
  
  <meta property="og:title" content="LibrAI ‚Ä¢ Scopri libri con l'Intelligenza Artificiale">
  <meta property="og:description" content="Non sai cosa leggere? Chiedi a LibrAI. Ottieni riassunti, pro & contro e piani di studio in secondi.">
  <meta property="og:image" content="https://images.unsplash.com/photo-1495446815901-a7297e633e8d?auto=format&fit=crop&w=1200&q=80">
  <meta property="og:url" content="https://librai.app">
  <meta property="og:type" content="website">
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="LibrAI ‚Ä¢ Book Discovery Engine">
  <meta name="twitter:description" content="Il modo pi√π smart per scegliere il prossimo libro.">
  <meta name="twitter:image" content="https://images.unsplash.com/photo-1495446815901-a7297e633e8d?auto=format&fit=crop&w=1200&q=80">
  
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <style>
    /* --- STILI BASE --- */
    :root {
      --bg-body: #0f172a;
      --bg-card: #1e293b;
      --bg-nav: rgba(15, 23, 42, 0.85);
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --border-color: rgba(148, 163, 184, 0.2);
      --primary: #0ea5e9;
      --primary-glow: rgba(14, 165, 233, 0.4);
      --secondary: #6366f1;
      --success: #22c55e;
      --warning: #fbbf24;
      --danger: #ef4444;
      --radius-l: 24px;
      --font-main: "Plus Jakarta Sans", sans-serif;
    }

    [data-theme="light"] {
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      --bg-nav: rgba(255, 255, 255, 0.85);
      --text-main: #0f172a;
      --text-muted: #64748b;
      --border-color: #e2e8f0;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: var(--font-main); background: var(--bg-body); color: var(--text-main); overflow-x: hidden; min-height: 100vh; }
    button { font-family: inherit; border: none; background: none; cursor: pointer; }
    a { text-decoration: none; color: inherit; }

    /* --- LAYOUT --- */
    .container { max-width: 1100px; margin: 0 auto; padding: 0 1.5rem; }
    
    .navbar {
      position: sticky; top: 0; z-index: 100; height: 72px;
      background: var(--bg-nav); backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border-color);
      display: flex; align-items: center;
    }
    .nav-content { display: flex; justify-content: space-between; align-items: center; width: 100%; }

    .brand { display: flex; align-items: center; gap: 0.6rem; font-size: 1.4rem; cursor: pointer; letter-spacing: -0.02em; }
    .brand-icon { width: 38px; height: 38px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 0.9rem; box-shadow: 0 0 20px var(--primary-glow); }
    .brand-text { font-weight: 600; }
    .brand-text span { font-weight: 800; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    .nav-actions { display: flex; align-items: center; gap: 1rem; }
    .nav-btn { position: relative; font-size: 1.2rem; color: var(--text-muted); padding: 8px; border-radius: 50%; transition: 0.2s; }
    .nav-btn:hover { color: var(--primary); background: rgba(14, 165, 233, 0.1); }
    .nav-badge { position: absolute; top: 4px; right: 4px; background: var(--danger); color: white; font-size: 0.6rem; font-weight: 700; padding: 2px 5px; border-radius: 99px; display: none; }

    /* --- VIEWS --- */
    .view { display: none; padding-bottom: 6rem; animation: fadeIn 0.4s ease-out; }
    .view.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- HERO --- */
    .hero { text-align: center; padding: 4.5rem 0 2rem; max-width: 800px; margin: 0 auto; }
    .hero h1 { font-size: clamp(2.5rem, 5vw, 3.8rem); line-height: 1.1; margin-bottom: 1.2rem; font-weight: 800; }
    .gradient-text { background: linear-gradient(to right, var(--text-main), var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .hero p { font-size: 1.15rem; color: var(--text-muted); margin-bottom: 2.5rem; line-height: 1.6; max-width: 600px; margin-left: auto; margin-right: auto; }

    /* --- SEARCH & LUCKY --- */
    .search-wrapper { position: relative; max-width: 600px; margin: 0 auto 1.5rem; display: flex; gap: 0.5rem; flex-direction: column; }
    @media (min-width: 600px) { .search-wrapper { flex-direction: row; } }
    
    .search-input-box { position: relative; flex: 1; }
    .search-input { width: 100%; padding: 1.2rem 1.5rem; padding-right: 3.5rem; border-radius: 99px; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main); font-size: 1.1rem; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5); outline: none; transition: all 0.2s; }
    .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-glow); }
    
    .search-btn-icon { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 42px; height: 42px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; transition: 0.2s; }
    .search-btn-icon:hover { transform: translateY(-50%) scale(1.05); }

    .lucky-btn { 
      padding: 0 1.5rem; height: 58px; border-radius: 99px; 
      background: var(--bg-card); border: 1px solid var(--border-color); 
      color: var(--text-muted); font-weight: 600; cursor: pointer; 
      display: flex; align-items: center; justify-content: center; gap: 0.5rem;
      transition: 0.2s; white-space: nowrap;
    }
    .lucky-btn:hover { border-color: var(--secondary); color: var(--secondary); background: rgba(99, 102, 241, 0.05); }
    .lucky-icon { font-size: 1.2rem; }

    .tags-container { display: flex; justify-content: center; gap: 0.8rem; flex-wrap: wrap; margin-top: 1.5rem; }
    .tag-chip { padding: 0.6rem 1.2rem; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 99px; color: var(--text-muted); font-size: 0.9rem; font-weight: 600; transition: 0.2s; }
    .tag-chip:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); }

    /* --- BOOK OF THE DAY --- */
    .daily-section { margin-top: 4rem; text-align: center; }
    .daily-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; color: var(--primary); font-weight: 700; margin-bottom: 1rem; display: block; }
    
    .daily-card { 
      max-width: 500px; margin: 0 auto; 
      background: linear-gradient(135deg, rgba(15,23,42,0.8), rgba(30,41,59,0.9)); 
      border: 1px solid var(--primary); border-radius: var(--radius-l); 
      padding: 1.5rem; display: flex; gap: 1.5rem; align-items: center;
      box-shadow: 0 0 40px rgba(14, 165, 233, 0.15); cursor: pointer;
      transition: transform 0.3s; text-align: left;
    }
    .daily-card:hover { transform: scale(1.02); }
    
    .daily-cover { 
      width: 100px; height: 140px; border-radius: 12px; flex-shrink: 0;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6); 
      display: flex; align-items: center; justify-content: center; font-size: 2.5rem;
      box-shadow: 0 10px 20px rgba(0,0,0,0.3);
    }
    .daily-content h3 { margin: 0 0 0.5rem 0; font-size: 1.3rem; line-height: 1.2; }
    .daily-content p { margin: 0 0 1rem 0; font-size: 0.9rem; color: var(--text-muted); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .daily-badge { background: var(--primary); color: white; padding: 0.3rem 0.8rem; border-radius: 99px; font-size: 0.75rem; font-weight: 700; display: inline-block; }

    /* --- BOOK GRID & CARDS --- */
    .books-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2rem; margin-top: 3rem; }
    
    .book-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-l); padding: 1.2rem; display: flex; flex-direction: column; gap: 1rem; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; }
    .book-card:hover { transform: translateY(-8px); border-color: var(--primary); }

    .card-fav-btn {
      position: absolute; top: 1rem; right: 1rem;
      width: 32px; height: 32px; border-radius: 50%;
      background: rgba(0,0,0,0.3); backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 1.1rem; z-index: 10;
      transition: 0.2s; opacity: 0; transform: translateY(-5px);
    }
    .book-card:hover .card-fav-btn { opacity: 1; transform: translateY(0); }
    .card-fav-btn.active { color: var(--danger); opacity: 1; transform: translateY(0); background: rgba(255,255,255,0.9); }
    .card-fav-btn:hover { transform: scale(1.1); }

    .book-header { display: flex; gap: 1rem; }
    .book-cover { width: 80px; height: 110px; border-radius: 12px; background: linear-gradient(135deg, #475569, #1e293b); display: flex; align-items: center; justify-content: center; font-size: 2rem; flex-shrink: 0; box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
    
    .book-meta { display: flex; flex-direction: column; justify-content: center; }
    .book-title { font-weight: 700; font-size: 1.1rem; line-height: 1.3; margin: 0 0 0.3rem 0; }
    .book-author { font-size: 0.9rem; color: var(--text-muted); }
    .rating { display: inline-flex; align-items: center; gap: 0.3rem; font-size: 0.85rem; margin-top: 0.5rem; font-weight: 600; }
    .star { color: var(--warning); }
    
    .book-desc-preview { font-size: 0.9rem; color: var(--text-muted); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
    
    .book-footer { margin-top: auto; display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--border-color); }
    .price-badge { font-weight: 700; color: var(--success); font-size: 1.1rem; }
    .action-link { font-size: 0.85rem; color: var(--primary); font-weight: 700; display: flex; align-items: center; gap: 4px; }

    /* --- MODAL --- */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 200; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
    .modal-overlay.open { display: flex; opacity: 1; }
    .modal-card { background: var(--bg-body); width: 90%; max-width: 650px; max-height: 90vh; border-radius: var(--radius-l); border: 1px solid var(--border-color); position: relative; overflow: hidden; display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.3s; }
    .modal-overlay.open .modal-card { transform: scale(1); }
    
    .modal-header-actions { position: absolute; top: 1rem; right: 1rem; z-index: 20; display: flex; gap: 0.5rem; }
    .icon-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-main); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
    .icon-btn:hover { background: var(--bg-body); transform: scale(1.05); }
    .icon-btn.fav-btn.active { color: var(--danger); border-color: var(--danger); background: rgba(239, 68, 68, 0.1); }

    .modal-content { padding: 2.5rem; flex: 1; overflow-y: auto; }

    /* --- LUCKY ANIMATION --- */
    .lucky-overlay { 
      position: fixed; inset: 0; z-index: 300; 
      background: var(--bg-body); display: none; 
      flex-direction: column; align-items: center; justify-content: center; 
    }
    .lucky-overlay.active { display: flex; }
    .book-flip { font-size: 5rem; animation: flip 0.8s infinite linear; }
    @keyframes flip { 0% { transform: perspective(600px) rotateY(0deg); } 100% { transform: perspective(600px) rotateY(360deg); } }

    /* --- COMPONENTS --- */
    .tab-nav { display: flex; gap: 1.5rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
    .tab-btn { padding: 0.5rem 0; color: var(--text-muted); font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-panel { display: none; animation: fadeIn 0.3s; }
    .tab-panel.active { display: block; }

    .feature-grid { display: flex; flex-wrap: wrap; gap: 0.8rem; margin-top: 1.5rem; }
    .feature-btn { font-size: 0.85rem; padding: 0.5rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-body); color: var(--text-muted); cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem; flex: 1; justify-content: center; min-width: 140px; }
    .feature-btn:hover { border-color: var(--secondary); color: var(--secondary); background: rgba(99, 102, 241, 0.05); }

    .ai-result-box { margin-top: 1rem; padding: 1.2rem; background: rgba(15, 23, 42, 0.4); border: 1px solid var(--border-color); border-radius: 12px; display: none; line-height: 1.6; }
    .ai-result-box h4 { margin-top: 0; color: var(--primary); }
    .ai-result-box ul { padding-left: 1.2rem; margin-bottom: 0; }
    
    .btn-amazon { width: 100%; background: linear-gradient(to bottom right, #f59e0b, #d97706); color: #fff; font-weight: 700; padding: 1rem; border-radius: 12px; margin-top: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 0.6rem; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3); }
    .btn-amazon:hover { transform: translateY(-2px); }

    /* Chat */
    .chat-box { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; height: 250px; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.8rem; margin-bottom: 1rem; }
    .chat-message { padding: 0.8rem 1rem; border-radius: 12px; font-size: 0.9rem; max-width: 85%; }
    .chat-message.user { align-self: flex-end; background: rgba(14, 165, 233, 0.15); border: 1px solid rgba(14, 165, 233, 0.3); }
    .chat-message.ai { align-self: flex-start; background: var(--bg-body); border: 1px solid var(--border-color); color: var(--text-muted); }
    .chat-input { width: 100%; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 99px; padding: 0.7rem 1.2rem; color: var(--text-main); outline: none; }
    .chat-input:focus { border-color: var(--primary); }

    /* Loader */
    .skeleton { background: linear-gradient(90deg, var(--bg-card) 25%, var(--border-color) 50%, var(--bg-card) 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 8px; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .loader-spinner { border: 3px solid rgba(255,255,255,0.1); border-left-color: var(--primary); border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Toast Notification */
    .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--surface); border: 1px solid var(--border-color); padding: 0.8rem 1.5rem; border-radius: 99px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 0.8rem; opacity: 0; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 1000; background: #0f172a; color: white; border: 1px solid #334155; }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <nav class="navbar">
    <div class="container nav-content">
      <div class="brand" onclick="app.router('home')">
        <div class="brand-icon">AI</div>
        <div class="brand-text">Libr<span>AI</span></div>
      </div>
      
      <div class="nav-actions">
        <button class="nav-btn" onclick="app.router('favorites')" title="I miei libri">
          ‚ô•
          <span class="nav-badge" id="fav-badge">0</span>
        </button>
        <button class="nav-btn" onclick="app.toggleTheme()" title="Cambia tema">
          ‚òÄ
        </button>
      </div>
    </div>
  </nav>

  <main class="container">
    
    <!-- VIEW: HOME -->
    <section id="view-home" class="view active">
      <div class="hero">
        <h1>Trova il libro perfetto con <span class="gradient-text">LibrAI</span></h1>
        <p>L'intelligenza artificiale che legge, analizza e confronta i prezzi per te. Inserisci un argomento o un titolo.</p>
        
        <div class="search-wrapper">
          <div class="search-input-box">
            <input type="text" class="search-input" id="mainSearchInput" placeholder="Es. 'Romanzi gialli psicologici' o 'Marketing'..." />
            <button class="search-btn-icon" onclick="app.handleSearch()">
              <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
          </div>
          <button class="lucky-btn" onclick="app.imFeelingLucky()">
            <span class="lucky-icon">üçÄ</span> Mi sento fortunato
          </button>
        </div>

        <div class="tags-container">
          <button class="tag-chip" onclick="app.searchTag('Business & Startup')">üíº Business</button>
          <button class="tag-chip" onclick="app.searchTag('Psicologia Cognitiva')">üß† Psicologia</button>
          <button class="tag-chip" onclick="app.searchTag('Thriller Nordici')">‚ùÑÔ∏è Thriller</button>
          <button class="tag-chip" onclick="app.searchTag('Futuro e AI')">üöÄ Futuro</button>
        </div>
      </div>

      <!-- LIBRO DEL GIORNO -->
      <div class="daily-section">
        <span class="daily-label">‚ú® Libro del Giorno</span>
        <div id="daily-container">
          <!-- Iniettato via JS -->
        </div>
      </div>

      <div style="margin-top: 3rem;">
        <h3 style="font-weight:800; margin-bottom:1rem; font-size:1.5rem;">I pi√π richiesti oggi</h3>
        <div class="books-grid" id="featured-grid">
          <!-- JS Insert -->
        </div>
      </div>
    </section>

    <!-- VIEW: SEARCH -->
    <section id="view-search" class="view">
      <div style="margin-top: 2rem; display: flex; align-items: center; gap: 1rem;">
        <button onclick="app.router('home')" style="color:var(--text-muted); font-weight:600; display:flex; align-items:center; gap:0.5rem;">‚Üê Home</button>
      </div>
      <h2 style="margin: 1rem 0;">Risultati per: <span class="gradient-text" id="query-display">...</span></h2>
      <div id="loading-indicator" style="display:none; text-align:center; padding: 6rem 0;">
        <div class="loader-spinner" style="display:inline-block; margin-bottom:1rem;"></div>
        <p style="color:var(--text-muted);">LibrAI sta analizzando migliaia di titoli...</p>
      </div>
      <div class="books-grid" id="results-grid"></div>
    </section>

    <!-- VIEW: FAVORITES -->
    <section id="view-favorites" class="view">
      <div style="margin-top: 2rem; display: flex; align-items: center; gap: 1rem;">
        <button onclick="app.router('home')" style="color:var(--text-muted); font-weight:600;">‚Üê Home</button>
      </div>
      <h2 style="margin: 1rem 0;">La mia Libreria <span style="color:var(--danger)">‚ô•</span></h2>
      <div id="favorites-empty" style="text-align:center; padding: 4rem 0; display:none;">
        <div style="font-size:3rem; margin-bottom:1rem; opacity:0.5;">üìö</div>
        <p style="color:var(--text-muted);">Non hai ancora salvato nessun libro.</p>
        <button onclick="app.router('home')" style="color:var(--primary); font-weight:700; margin-top:0.5rem;">Inizia a esplorare</button>
      </div>
      <div class="books-grid" id="favorites-grid"></div>
    </section>

  </main>

  <!-- MODAL -->
  <div class="modal-overlay" id="bookModal">
    <div class="modal-card">
      <div class="modal-header-actions">
        <button class="icon-btn fav-btn" id="modal-fav-btn" onclick="app.toggleModalFavorite()">‚ô•</button>
        <button class="icon-btn" onclick="app.closeModal()">√ó</button>
      </div>
      <div class="modal-content" id="modal-content-area"></div>
    </div>
  </div>

  <!-- LUCKY ANIMATION OVERLAY -->
  <div class="lucky-overlay" id="luckyOverlay">
    <div class="book-flip">üìñ</div>
    <h3 style="margin-top:1.5rem; color:var(--text-main);">Sto cercando il libro perfetto...</h3>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast">
    <span style="font-size:1.2rem;">‚úÖ</span>
    <span id="toast-msg">Libro salvato nei preferiti</span>
  </div>

  <script>
    const referralTag = "filmshokblogs-21"; 
    
    // DB Ampliato per la rotazione giornaliera
    const FULL_DB = [
      { id: 101, title: "Atomic Habits", author: "James Clear", tags: ["Crescita", "Abitudini"], rating: 4.8, price: 15.90, oldPrice: 22.00, color: "linear-gradient(135deg, #f59e0b, #d97706)", summary: "Il manuale definitivo per costruire buone abitudini un 1% alla volta." },
      { id: 102, title: "L'Arte della Guerra", author: "Sun Tzu", tags: ["Strategia", "Classici"], rating: 4.6, price: 9.90, oldPrice: 12.00, color: "linear-gradient(135deg, #ef4444, #b91c1c)", summary: "Strategia pura per vincere le sfide della vita senza combattere." },
      { id: 103, title: "Sapiens", author: "Yuval Noah Harari", tags: ["Storia", "Umanit√†"], rating: 4.9, price: 18.00, oldPrice: 24.00, color: "linear-gradient(135deg, #10b981, #059669)", summary: "Come siamo passati da scimmie insignificanti a padroni del mondo." },
      { id: 104, title: "1984", author: "George Orwell", tags: ["Distopia"], rating: 4.8, price: 10.50, oldPrice: 14.00, color: "linear-gradient(135deg, #475569, #1e293b)", summary: "Il capolavoro distopico sul controllo e la perdita della libert√†." },
      { id: 105, title: "Pensieri Lenti e Veloci", author: "Daniel Kahneman", tags: ["Psicologia"], rating: 4.7, price: 16.90, oldPrice: 22.00, color: "linear-gradient(135deg, #3b82f6, #1d4ed8)", summary: "Scopri come il tuo cervello ti inganna nel prendere decisioni." },
      { id: 106, title: "L'Arte della Vittoria", author: "Phil Knight", tags: ["Business"], rating: 4.9, price: 14.00, oldPrice: 19.00, color: "linear-gradient(135deg, #0ea5e9, #0284c7)", summary: "La folle corsa imprenditoriale dietro la creazione della Nike." },
      { id: 107, title: "Psicologia dei Soldi", author: "Morgan Housel", tags: ["Finanza"], rating: 4.7, price: 13.50, oldPrice: 18.00, color: "linear-gradient(135deg, #14b8a6, #0f766e)", summary: "I soldi non sono fogli di calcolo, sono emozioni. Impara a gestirle." },
      { id: 108, title: "Steve Jobs", author: "Walter Isaacson", tags: ["Biografia"], rating: 4.8, price: 19.00, oldPrice: 25.00, color: "linear-gradient(135deg, #6366f1, #4f46e5)", summary: "Il ritratto crudo di un genio che ha piegato la realt√† al suo volere." },
      { id: 109, title: "Deep Work", author: "Cal Newport", tags: ["Produttivit√†"], rating: 4.6, price: 17.50, oldPrice: 23.00, color: "linear-gradient(135deg, #e11d48, #be123c)", summary: "Impara a concentrarti in un mondo distratto. Un superpotere moderno." },
      { id: 110, title: "Dune", author: "Frank Herbert", tags: ["Sci-Fi"], rating: 4.9, price: 16.00, oldPrice: 22.00, color: "linear-gradient(135deg, #d97706, #92400e)", summary: "L'epopea fantascientifica definitiva su politica, religione ed ecologia." },
      { id: 111, title: "Il Piccolo Principe", author: "A. de Saint-Exup√©ry", tags: ["Classici"], rating: 4.9, price: 8.00, oldPrice: 10.00, color: "linear-gradient(135deg, #fbbf24, #f59e0b)", summary: "Una fiaba per adulti che insegna a vedere col cuore." },
      { id: 112, title: "Il Signore degli Anelli", author: "J.R.R. Tolkien", tags: ["Fantasy"], rating: 5.0, price: 25.00, oldPrice: 35.00, color: "linear-gradient(135deg, #15803d, #14532d)", summary: "Il viaggio epico che ha definito il genere fantasy moderno." }
    ];

    let CURRENT_RESULTS = [];
    let CURRENT_ACTIVE_BOOK = null;
    let FAVORITES = [];

    const app = {
      state: { theme: 'dark' },

      init() {
        const savedTheme = localStorage.getItem('librai_theme') || 'dark';
        this.setTheme(savedTheme);
        this.loadFavorites();

        // 1. Calcola il "Seme" Giornaliero
        const seed = this.getDailySeed();
        
        // 2. Mescola il DB in modo deterministico basato sulla data
        const shuffledDB = this.shuffleArrayWithSeed([...FULL_DB], seed);
        
        // 3. Seleziona Libro del Giorno (il primo) e Featured (i successivi 6)
        const dailyBook = shuffledDB[0];
        const featuredBooks = shuffledDB.slice(1, 7);

        this.renderDailyBook(dailyBook);
        this.renderCards(featuredBooks, 'featured-grid');

        // Events
        document.getElementById('mainSearchInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') this.handleSearch(); });
        document.getElementById('bookModal').onclick = (e) => { if (e.target.id === 'bookModal') this.closeModal(); }
      },

      /* --- DAILY LOGIC --- */
      getDailySeed() {
        // Crea un numero unico basato sulla data (YYYYMMDD)
        const today = new Date();
        const str = `${today.getFullYear()}${today.getMonth() + 1}${today.getDate()}`;
        return parseInt(str);
      },

      shuffleArrayWithSeed(array, seed) {
        // Algoritmo di shuffle deterministico
        let m = array.length, t, i;
        while (m) {
          // Generatore pseudo-random
          seed = (seed * 9301 + 49297) % 233280;
          let random = seed / 233280;
          
          i = Math.floor(random * m--);
          t = array[m];
          array[m] = array[i];
          array[i] = t;
        }
        return array;
      },

      renderDailyBook(book) {
        const container = document.getElementById('daily-container');
        const bookStr = JSON.stringify(book).replace(/"/g, '&quot;');
        
        container.innerHTML = `
          <div class="daily-card" onclick='app.openModalFromObj(${bookStr})'>
            <div class="daily-cover" style="background:${book.color}">üìñ</div>
            <div class="daily-content">
              <h3>${book.title}</h3>
              <p>${book.author}</p>
              <p>${book.summary}</p>
              <span class="daily-badge">Consigliato oggi</span>
            </div>
          </div>
        `;
      },

      /* --- LUCKY LOGIC --- */
      imFeelingLucky() {
        const overlay = document.getElementById('luckyOverlay');
        overlay.classList.add('active');

        // Attendi 1.5 secondi di animazione
        setTimeout(() => {
          overlay.classList.remove('active');
          // Pesca un libro random dal DB completo
          const randomBook = FULL_DB[Math.floor(Math.random() * FULL_DB.length)];
          this.openModalFromObj(randomBook);
        }, 1500);
      },

      /* --- FAVORITES LOGIC --- */
      loadFavorites() {
        const saved = localStorage.getItem('librai_favorites');
        FAVORITES = saved ? JSON.parse(saved) : [];
        this.updateFavBadge();
      },

      isFav(id) { return FAVORITES.some(b => b.id === id); },

      toggleFavorite(book, event) {
        if(event) event.stopPropagation(); 
        if (this.isFav(book.id)) {
          FAVORITES = FAVORITES.filter(b => b.id !== book.id);
          this.showToast("Rimosso dai preferiti");
        } else {
          FAVORITES.push(book);
          this.showToast("Aggiunto ai preferiti");
        }
        localStorage.setItem('librai_favorites', JSON.stringify(FAVORITES));
        this.updateFavBadge();
        // Refresh views
        this.init(); // Refresh Home cards icons
        if(CURRENT_RESULTS.length) this.renderCards(CURRENT_RESULTS, 'results-grid');
        this.renderFavorites();
      },

      toggleModalFavorite() {
        if (!CURRENT_ACTIVE_BOOK) return;
        this.toggleFavorite(CURRENT_ACTIVE_BOOK);
        const btn = document.getElementById('modal-fav-btn');
        if (this.isFav(CURRENT_ACTIVE_BOOK.id)) btn.classList.add('active');
        else btn.classList.remove('active');
      },

      updateFavBadge() {
        const badge = document.getElementById('fav-badge');
        badge.textContent = FAVORITES.length;
        badge.style.display = FAVORITES.length > 0 ? 'block' : 'none';
      },

      renderFavorites() {
        const grid = document.getElementById('favorites-grid');
        const empty = document.getElementById('favorites-empty');
        if (FAVORITES.length === 0) {
          grid.innerHTML = '';
          empty.style.display = 'block';
        } else {
          empty.style.display = 'none';
          this.renderCards(FAVORITES, 'favorites-grid');
        }
      },

      showToast(msg) {
        const toast = document.getElementById('toast');
        document.getElementById('toast-msg').textContent = msg;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
      },

      /* --- ROUTER --- */
      router(viewName) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + viewName).classList.add('active');
        window.scrollTo(0,0);
        if (viewName === 'favorites') this.renderFavorites();
      },

      /* --- SEARCH --- */
      async handleSearch() {
        const query = document.getElementById('mainSearchInput').value.trim();
        if (!query) return;
        this.searchTag(query);
      },

      async searchTag(query) {
        document.getElementById('mainSearchInput').value = query;
        document.getElementById('query-display').textContent = query;
        
        const grid = document.getElementById('results-grid');
        const loader = document.getElementById('loading-indicator');
        grid.innerHTML = '';
        loader.style.display = 'block';
        this.router('search');

        try {
          const results = await this.fetchBooksFromBackend(query);
          loader.style.display = 'none';
          if (results && results.length > 0) {
            CURRENT_RESULTS = results;
            this.renderCards(results, 'results-grid');
          } else {
            grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:3rem; color:var(--text-muted);">Nessun risultato trovato.</div>`;
          }
        } catch (error) {
          loader.style.display = 'none';
          grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:3rem; color:var(--danger);">Errore AI. Riprova.</div>`;
        }
      },

      async fetchBooksFromBackend(userQuery) {
        // PROMPT ANTI-SPOILER
        const prompt = `Sei LibrAI. L'utente cerca: "${userQuery}". Genera JSON con 6 libri.
        IMPORTANTE: Non fare mai spoiler sul finale o sui colpi di scena.
        Struttura array oggetti: {id (numero), title, author, tags[], rating (float), price (float), oldPrice, summary (string), color (css gradient)}. Rispondi solo JSON.`;
        
        try {
          const res = await fetch('/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt })
          });
          const data = await res.json();
          let text = data.candidates[0].content.parts[0].text;
          text = text.replace(/```json/g, '').replace(/```/g, '').trim();
          return JSON.parse(text);
        } catch (e) {
          console.error(e);
          return [];
        }
      },

      /* --- RENDER --- */
      renderCards(books, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = books.map(book => {
          const bookStr = JSON.stringify(book).replace(/"/g, '&quot;');
          const isFav = this.isFav(book.id);
          return `
          <div class="book-card" onclick='app.openModalFromObj(${bookStr})'>
            <button class="card-fav-btn ${isFav ? 'active' : ''}" onclick='app.toggleFavorite(${bookStr}, event)'>‚ô•</button>
            <div class="book-header">
              <div class="book-cover" style="background:${book.color}">üìñ</div>
              <div class="book-meta">
                <h3 class="book-title">${book.title}</h3>
                <div class="book-author">${book.author}</div>
                <div class="rating"><span class="star">‚òÖ</span> ${book.rating}</div>
              </div>
            </div>
            <p class="book-desc-preview">${book.summary}</p>
            <div class="book-footer">
              <div class="price-badge">${book.price.toFixed(2)}‚Ç¨</div>
              <div class="action-link">Riassunto ‚Üí</div>
            </div>
          </div>
        `}).join('');
      },

      openModalFromObj(book) {
        CURRENT_ACTIVE_BOOK = book;
        const modal = document.getElementById('bookModal');
        const content = document.getElementById('modal-content-area');
        const favBtn = document.getElementById('modal-fav-btn');
        
        if(this.isFav(book.id)) favBtn.classList.add('active');
        else favBtn.classList.remove('active');

        modal.classList.add('open');
        document.body.style.overflow = 'hidden';

        content.innerHTML = `<div class="skeleton" style="height:200px; width:100%; border-radius:12px;"></div>`;

        const cleanTitle = book.title.replace(/[^\w\s]/gi, ''); 
        const link = `https://www.amazon.it/s?k=${encodeURIComponent(cleanTitle + ' ' + book.author)}&tag=${referralTag}`;

        setTimeout(() => {
          content.innerHTML = `
            <div style="display:flex; flex-wrap:wrap; gap:1.5rem; margin-bottom:1.5rem;">
              <div style="width:100px; height:140px; border-radius:12px; background:${book.color}; display:flex; align-items:center; justify-content:center; font-size:2.5rem;">üìñ</div>
              <div style="flex:1;">
                <div class="ai-badge">‚ú® LibrAI Analysis</div>
                <h1 style="margin:0 0 0.5rem 0; line-height:1.2;">${book.title}</h1>
                <p style="color:var(--text-muted);">di ${book.author}</p>
                <div style="margin-top:0.5rem;"><span style="font-size:1.4rem; font-weight:700; color:var(--success);">${book.price.toFixed(2)}‚Ç¨</span></div>
              </div>
            </div>

            <div class="tab-nav">
              <div class="tab-btn active" onclick="app.switchTab('overview', this)">Panoramica</div>
              <div class="tab-btn" onclick="app.switchTab('chat', this)">Chiedi al Libro</div>
            </div>

            <div id="tab-overview" class="tab-panel active">
              <div style="background:var(--bg-card); border:1px solid var(--primary); padding:1.5rem; border-radius:16px;">
                <p style="line-height:1.6; margin-top:0;">${book.summary}</p>
                <div class="feature-grid">
                  <button class="feature-btn" onclick="app.generateContent(this, 'quotes')">üìú Citazioni</button>
                  <button class="feature-btn" onclick="app.generateContent(this, 'pros')">‚öñÔ∏è Pro & Contro</button>
                  <button class="feature-btn" onclick="app.generateContent(this, 'plan')">üìÖ Piano Lettura</button>
                </div>
                <div class="ai-result-box" id="ai-result"></div>
              </div>
              <a href="${link}" target="_blank" class="btn-amazon">Acquista su Amazon.it</a>
            </div>

            <div id="tab-chat" class="tab-panel">
               <div class="chat-box" id="chat-box-area">
                 <div class="chat-message ai">Ciao! Chiedimi qualsiasi cosa su "${book.title}".</div>
               </div>
               <div style="display:flex; gap:0.5rem;">
                 <input type="text" id="chat-input" class="chat-input" placeholder="Scrivi..." onkeypress="if(event.key === 'Enter') app.sendChat()">
                 <button class="chat-send-btn" onclick="app.sendChat()" style="background:var(--primary); color:white; width:40px; height:40px; border-radius:50%;">‚û§</button>
               </div>
            </div>
          `;
        }, 150);
      },

      closeModal() {
        document.getElementById('bookModal').classList.remove('open');
        document.body.style.overflow = '';
      },

      switchTab(name, btn) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        document.getElementById(`tab-${name}`).classList.add('active');
      },

      async generateContent(btn, type) {
        const prompts = {
          quotes: `Estrai 3 citazioni brevi da "${CURRENT_ACTIVE_BOOK.title}". No spoiler.`,
          pros: `3 Pro e 3 Contro del libro "${CURRENT_ACTIVE_BOOK.title}". No spoiler. Format HTML list.`,
          plan: `Piano lettura 5 giorni per "${CURRENT_ACTIVE_BOOK.title}". No spoiler. Format HTML list.`
        };
        const orig = btn.innerText;
        btn.innerText = "Caricamento..."; btn.disabled = true;
        
        try {
          const res = await fetch('/api/generate', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: prompts[type] })
          });
          const data = await res.json();
          const text = data.candidates[0].content.parts[0].text.replace(/```html/g,'').replace(/```/g,'');
          
          const box = document.getElementById('ai-result');
          box.innerHTML = text.replace(/\n/g, '<br>');
          box.style.display = 'block';
        } catch(e) { console.error(e); }
        btn.innerText = orig; btn.disabled = false;
      },

      async sendChat() {
        const input = document.getElementById('chat-input');
        const box = document.getElementById('chat-box-area');
        const msg = input.value.trim();
        if(!msg) return;

        box.innerHTML += `<div class="chat-message user">${msg}</div>`;
        input.value = '';
        box.scrollTop = box.scrollHeight;

        try {
          const res = await fetch('/api/generate', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ prompt: `Esperto libro "${CURRENT_ACTIVE_BOOK.title}". User: "${msg}". Risposta breve italiano. NON FARE SPOILER SUL FINALE.` })
          });
          const data = await res.json();
          const text = data.candidates[0].content.parts[0].text;
          box.innerHTML += `<div class="chat-message ai">${text}</div>`;
        } catch(e) {
          box.innerHTML += `<div class="chat-message ai">Errore connessione.</div>`;
        }
        box.scrollTop = box.scrollHeight;
      },

      toggleTheme() {
        const newTheme = this.state.theme === 'dark' ? 'light' : 'dark';
        this.setTheme(newTheme);
      },
      setTheme(t) {
        this.state.theme = t;
        document.documentElement.setAttribute('data-theme', t);
        localStorage.setItem('librai_theme', t);
      }
    };

    app.init();
  </script>
</body>
</html>
